require('dotenv').config();
const express = require('express');
const cors    = require('cors');
const helmet  = require('helmet');
const morgan  = require('morgan');
const path    = require('path');

const authRoutes      = require('./src/routes/auth');
const scanRoutes      = require('./src/routes/scans');
const forecastRoutes  = require('./src/routes/forecast');
const districtRoutes  = require('./src/routes/districts');
const { checkMLHealth } = require('./src/services/mlService');

const app  = express();
const PORT = process.env.PORT || 5000;

// â”€â”€ MIDDLEWARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(helmet());
app.use(cors({ origin: '*' }));
app.use(morgan('dev'));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// â”€â”€ TEST PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/test', (req, res) => {
  res.sendFile(path.join(__dirname, 'test.html'));
});

// â”€â”€ ROUTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use('/api/auth',      authRoutes);
app.use('/api/scans',     scanRoutes);
app.use('/api/forecast',  forecastRoutes);
app.use('/api/districts', districtRoutes);

// â”€â”€ ROOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/', (req, res) => {
  res.json({
    service : 'KrishiSat AI â€” Backend',
    version : '1.0.0',
    status  : 'running âœ…',
    endpoints: {
      auth     : '/api/auth',
      scans    : '/api/scans',
      forecast : '/api/forecast',
      districts: '/api/districts'
    }
  });
});

// â”€â”€ HEALTH CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/health', async (req, res) => {
  try {
    const mlHealth = await checkMLHealth();
    res.json({
      status    : 'ok âœ…',
      backend   : 'running',
      ml_service: mlHealth
    });
  } catch {
    res.json({
      status    : 'partial âš ï¸',
      backend   : 'running',
      ml_service: 'unreachable'
    });
  }
});

// â”€â”€ 404 HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use((req, res) => {
  res.status(404).json({
    success: false,
    error  : `Route ${req.originalUrl} not found`
  });
});

// â”€â”€ ERROR HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    success: false,
    error  : err.message || 'Internal server error'
  });
});

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.listen(PORT, () => {
  console.log('â•'.repeat(50));
  console.log('  ğŸŒ¾ KrishiSat AI â€” Backend');
  console.log(`  ğŸš€ Running on http://localhost:${PORT}`);
  console.log(`  ğŸ¤– ML Service: ${process.env.ML_SERVICE_URL}`);
  console.log('â•'.repeat(50));
});

module.exports = app;
